<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Накопления</title>
  <meta name="theme-color" content="#f2f5fb" />
  <style>
:root{
  --bg:#f2f5fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --line:rgba(15,23,42,.08);
  --shadow:0 10px 30px rgba(2,6,23,.08);
  --accent:#16a34a;
  --danger:#ef4444;
  --radius:22px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --sans: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background: radial-gradient(900px 350px at 12% -5%, rgba(59,130,246,.10), transparent 60%),
              radial-gradient(900px 350px at 88% -10%, rgba(22,163,74,.10), transparent 60%),
              var(--bg);
  color:var(--text);
  font-family:var(--sans);
}

.app{max-width:460px;margin:0 auto;padding:18px 16px 28px}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:6px 4px 14px}
.title{font-size:28px;letter-spacing:-.02em;margin:0}

.icon-btn{
  border:0;background:rgba(255,255,255,.65);
  backdrop-filter:saturate(120%) blur(10px);
  -webkit-backdrop-filter:saturate(120%) blur(10px);
  box-shadow: 0 10px 20px rgba(2,6,23,.06);
  width:42px;height:42px;border-radius:999px;
  display:grid;place-items:center;cursor:pointer;color:var(--text);
}
.icon-btn:active{transform:translateY(1px)}
.icon-btn.close{width:40px;height:40px;background:rgba(15,23,42,.04);box-shadow:none}

.dot{width:5px;height:5px;border-radius:50%;background:rgba(15,23,42,.55);display:block;margin:2px 0}
.icon-btn .dot:nth-child(2){opacity:.35}
.icon-btn .dot:nth-child(3){opacity:.22}

.card{
  background:var(--card);
  border:1px solid rgba(15,23,42,.06);
  border-radius:var(--radius);
  box-shadow: var(--shadow);
}

.total-card{padding:16px 16px 14px;position:relative;overflow:hidden}
.total-card::before{
  content:"";position:absolute;inset:-40px -120px auto auto;
  width:240px;height:240px;background: radial-gradient(circle at 30% 30%, rgba(59,130,246,.25), transparent 60%);
  transform:rotate(16deg);pointer-events:none;
}
.kicker{font-size:13px;color:var(--muted);margin-bottom:8px}
.total-amount{font-size:34px;font-weight:740;letter-spacing:-.03em}
.divider{height:1px;background:var(--line);margin:14px 0 10px}
.subnote{font-size:12px;color:var(--muted)}

.section-head{
  margin-top:18px;
  display:flex;align-items:center;justify-content:space-between;
  gap:12px;padding:4px 2px 10px;
}
.section-title{display:flex;align-items:center;gap:6px}
.section-title h2{margin:0;font-size:22px;letter-spacing:-.02em}

.chev{
  border:0;background:transparent;color:rgba(15,23,42,.55);
  cursor:pointer;padding:8px 6px;border-radius:10px;
}
.chev:active{background:rgba(15,23,42,.04)}

.add-btn{
  border:0;width:44px;height:44px;border-radius:999px;
  background: rgba(22,163,74,.10);
  color: var(--accent);
  cursor:pointer;display:grid;place-items:center;
}
.add-btn:active{transform:translateY(1px)}

.list{display:flex;flex-direction:column;gap:10px}
.item{padding:14px 14px 12px;cursor:pointer;transition:transform .08s ease}
.item:active{transform:translateY(1px)}
.item-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
.amount{font-size:24px;font-weight:760;letter-spacing:-.02em}

/* NO BLUE: removed pct/right/bar/fill */

.meta{
  margin-top:4px;
  display:flex;align-items:center;gap:10px;
  color:var(--muted);font-size:13px;
}
.name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
.tail{font-family:var(--mono);font-size:12px;opacity:.9}
.until{margin-left:auto;font-size:12px;opacity:.9}

.footer{margin-top:16px;text-align:center;color:rgba(15,23,42,.45);font-size:12px}

/* Modal */
.modal-backdrop{
  position:fixed;inset:0;
  background: rgba(2,6,23,.45);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  z-index:50;
}
.modal{
  position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
  width:min(460px, calc(100% - 24px));
  background:var(--card);
  border:1px solid rgba(15,23,42,.08);
  border-radius:26px;
  box-shadow: 0 20px 60px rgba(2,6,23,.22);
  z-index:60;
  padding:14px 14px 16px;
}
.modal-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:4px 2px 10px}
.modal-kicker{font-size:12px;color:var(--muted)}
.modal-title{font-size:18px;font-weight:760;letter-spacing:-.02em;margin-top:2px}

.form{display:flex;flex-direction:column;gap:10px;padding:0 2px}
label{display:flex;flex-direction:column;gap:6px}
label span{font-size:12px;color:var(--muted)}
input{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(15,23,42,.12);
  outline:none;
  font-size:15px;
  background:rgba(15,23,42,.02);
}
input:focus{border-color:rgba(59,130,246,.55); box-shadow:0 0 0 4px rgba(59,130,246,.12)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:360px){.grid2{grid-template-columns:1fr}}

.actions{margin-top:6px;display:flex;gap:10px;justify-content:space-between}
button.primary{
  flex:1;border:0;padding:12px 14px;border-radius:14px;
  background: rgba(59,130,246,.95);
  color:white;font-size:15px;font-weight:700;cursor:pointer;
}
button.primary:active{transform:translateY(1px)}
button.ghost{
  border:1px solid rgba(239,68,68,.35);
  background: rgba(239,68,68,.08);
  color: var(--danger);
  padding:12px 14px;border-radius:14px;cursor:pointer;font-weight:700;
}

/* Toast */
.toast{
  position:fixed;left:50%;top:14px;transform:translateX(-50%);
  background: rgba(15,23,42,.92);
  color: white;
  padding:10px 12px;
  border-radius:999px;
  font-size:13px;
  box-shadow: 0 14px 40px rgba(2,6,23,.25);
  z-index:80;
}
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <h1 class="title">Накопления</h1>
      <button class="icon-btn" id="btnReset" aria-label="Сброс" title="Сброс к данным по умолчанию">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </button>
    </header>

    <section class="card total-card" aria-label="Всего средств">
      <div class="kicker">Всего средств</div>
      <div class="total-amount" id="totalAmount">—</div>
      <div class="divider"></div>
      <div class="subnote">Сумма по всем вкладам и счетам</div>
    </section>

    <section class="section-head">
      <div class="section-title">
        <h2>Вклады и счета</h2>
        <button class="chev" id="btnSort" title="Сортировка" aria-label="Сортировка">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <button class="add-btn" id="btnAdd" aria-label="Добавить" title="Добавить">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
          <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round"/>
        </svg>
      </button>
    </section>

    <main class="list" id="accountsList" aria-label="Список вкладов и счетов"></main>

    <footer class="footer">
      <span>Данные сохраняются на этом устройстве (localStorage).</span>
    </footer>
  </div>

  <div class="modal-backdrop" id="modalBackdrop" hidden></div>
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" hidden>
    <div class="modal-head">
      <div>
        <div class="modal-kicker" id="modalKicker">Добавить</div>
        <div class="modal-title" id="modalTitle">Вклад / счёт</div>
      </div>
      <button class="icon-btn close" id="btnClose" aria-label="Закрыть">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
          <path d="M6 6l12 12M18 6L6 18" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <form class="form" id="accountForm">
      <input type="hidden" id="fieldId" />
      <label>
        <span>Название</span>
        <input id="fieldName" required placeholder="Напр. paybox" maxlength="60" />
      </label>
      <label>
        <span>Сумма</span>
        <input id="fieldAmount" required inputmode="decimal" placeholder="0" />
      </label>
      <div class="grid2">
        <label>
          <span>Хвост</span>
          <input id="fieldTail" placeholder="6365" maxlength="16" />
        </label>
        <label>
          <span>Дата/пометка</span>
          <input id="fieldUntil" placeholder="18/10/26" maxlength="30" />
        </label>
      </div>

      <div class="actions">
        <button type="button" class="ghost" id="btnDelete" hidden>Удалить</button>
        <button type="submit" class="primary" id="btnSave">Сохранить</button>
      </div>
    </form>
  </div>

  <div class="toast" id="toast" hidden></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const STORAGE_KEY = "savings_full_working_v1";

  const defaults = [
    { id: cryptoRandomId(), name: "Менора (накопительный)", amount: 40000, tail: "6365", until: "" },
    { id: cryptoRandomId(), name: "menora keren ishtalmut", amount: 0, tail: "5098", until: "до 29 июн 2025" },
    { id: cryptoRandomId(), name: "Interaktive портфель ($)", amount: 11000, tail: "3571", until: "" },
    { id: cryptoRandomId(), name: "открытый счет в Discount", amount: 20050, tail: "", until: "" },
    { id: cryptoRandomId(), name: "закрытый счет Discount", amount: 253000, tail: "", until: "18/10/26" },
    { id: cryptoRandomId(), name: "наличные дома (kaplan)", amount: 4000, tail: "", until: "" },
    { id: cryptoRandomId(), name: "мой старый кошелек", amount: 930, tail: "", until: "" },
    { id: cryptoRandomId(), name: "paybox", amount: 5088, tail: "", until: "" },
    { id: cryptoRandomId(), name: "bit", amount: 1915, tail: "", until: "" },
  ];

  let accounts = load();
  let sortMode = "manual"; // manual | amount_desc | amount_asc | name_asc

  const $ = (id) => document.getElementById(id);

  function cryptoRandomId(){
    // Works everywhere (no need for crypto API)
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function fmtMoney(n){
    if (!isFinite(n)) return "—";
    const fixed = (Math.round(n * 100) / 100).toFixed(2);
    const [i, d] = fixed.split(".");
    const withSpaces = i.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    return `${withSpaces},${d}`;
  }

  function parseMoney(s){
    const clean = String(s ?? "").replace(/\s/g,"").replace(/,/g,".").replace(/[^\d.]/g,"");
    const n = Number(clean);
    return isFinite(n) ? n : NaN;
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return defaults;
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return defaults;
      return arr.map(x => ({
        id: String(x.id || cryptoRandomId()),
        name: String(x.name || "Счёт"),
        amount: Number(x.amount) || 0,
        tail: String(x.tail ?? ""),
        until: String(x.until ?? ""),
      }));
    }catch{
      return defaults;
    }
  }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(accounts));
  }

  function total(){
    return accounts.reduce((s,a)=>s+(Number(a.amount)||0),0);
  }

  function sortAccounts(list){
    const arr=[...list];
    if (sortMode==="amount_desc") arr.sort((a,b)=>(b.amount||0)-(a.amount||0));
    if (sortMode==="amount_asc") arr.sort((a,b)=>(a.amount||0)-(b.amount||0));
    if (sortMode==="name_asc") arr.sort((a,b)=>(a.name||"").localeCompare(b.name||"","ru"));
    return arr;
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function toast(msg){
    const t=$("toast");
    t.textContent=msg;
    t.hidden=false;
    clearTimeout(toast._t);
    toast._t=setTimeout(()=>t.hidden=true, 2000);
  }

  function render(){
    $("totalAmount").textContent = fmtMoney(total());
    const list=$("accountsList");
    list.innerHTML="";

    const sorted = sortAccounts(accounts);
    sorted.forEach(a=>{
      const el=document.createElement("section");
      el.className="card item";
      el.tabIndex=0;

      el.innerHTML = `
        <div class="item-top">
          <div class="amount">${fmtMoney(a.amount)}</div>
        </div>
        <div class="meta">
          <div class="name" title="${escapeHtml(a.name)}">${escapeHtml(a.name)}</div>
          <div class="tail">${a.tail ? "•• " + escapeHtml(a.tail) : ""}</div>
          <div class="until">${a.until ? escapeHtml(a.until) : ""}</div>
        </div>
      `;

      el.addEventListener("click", ()=>openModal(a.id));
      el.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" ") openModal(a.id); });

      list.appendChild(el);
    });
  }

  function openModal(id=null){
    const editing = !!id;
    const acc = editing ? accounts.find(a=>a.id===id) : null;

    $("modalKicker").textContent = editing ? "Редактировать" : "Добавить";
    $("fieldId").value = editing ? acc.id : "";
    $("fieldName").value = editing ? acc.name : "";
    $("fieldAmount").value = editing ? String(acc.amount).replace(".", ",") : "";
    $("fieldTail").value = editing ? acc.tail : "";
    $("fieldUntil").value = editing ? acc.until : "";

    $("btnDelete").hidden = !editing;

    $("modalBackdrop").hidden=false;
    $("modal").hidden=false;
    setTimeout(()=>$("fieldName").focus(), 0);
  }

  function closeModal(){
    $("modalBackdrop").hidden=true;
    $("modal").hidden=true;
  }

  function cycleSort(){
    const order=["manual","amount_desc","amount_asc","name_asc"];
    const idx=order.indexOf(sortMode);
    sortMode = order[(idx+1)%order.length];

    const map={
      manual:"Сортировка: как добавлено",
      amount_desc:"Сортировка: сумма ↓",
      amount_asc:"Сортировка: сумма ↑",
      name_asc:"Сортировка: по названию",
    };
    toast(map[sortMode] || "Сортировка");
    render();
  }

  // Wire UI
  $("btnAdd").addEventListener("click", ()=>openModal(null));
  $("btnClose").addEventListener("click", closeModal);
  $("modalBackdrop").addEventListener("click", closeModal);
  $("btnSort").addEventListener("click", cycleSort);

  $("btnReset").addEventListener("click", ()=>{
    const ok = confirm("Сбросить данные к исходным?");
    if(!ok) return;
    accounts = defaults.map(x=>({...x, id: cryptoRandomId()}));
    sortMode="manual";
    save();
    render();
    toast("Сброшено");
  });

  $("btnDelete").addEventListener("click", ()=>{
    const id=$("fieldId").value;
    const acc=accounts.find(a=>a.id===id);
    if(!acc) return;
    const ok=confirm(`Удалить “${acc.name}”?`);
    if(!ok) return;
    accounts = accounts.filter(a=>a.id!==id);
    save();
    closeModal();
    render();
    toast("Удалено");
  });

  $("accountForm").addEventListener("submit", (e)=>{
    e.preventDefault();
    const id = $("fieldId").value || cryptoRandomId();
    const name = $("fieldName").value.trim() || "Счёт";
    const amount = parseMoney($("fieldAmount").value);
    if(!isFinite(amount)){
      toast("Введите сумму");
      $("fieldAmount").focus();
      return;
    }
    const tail = $("fieldTail").value.trim();
    const until = $("fieldUntil").value.trim();

    const obj = { id, name, amount, tail, until };
    const idx = accounts.findIndex(a=>a.id===id);
    if(idx>=0) accounts[idx]=obj;
    else accounts.push(obj);

    save();
    closeModal();
    render();
    toast("Сохранено");
  });

  window.addEventListener("keydown", (e)=>{
    if(e.key==="Escape" && !$("modal").hidden) closeModal();
  });

  render();
});
</script>
</body>
</html>

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Накопления</title>
  <meta name="theme-color" content="#f2f5fb" />
  <style>
:root{
  --bg:#f2f5fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --line:rgba(15,23,42,.08);
  --shadow:0 10px 30px rgba(2,6,23,.08);
  --accent:#16a34a;
  --danger:#ef4444;
  --radius:22px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --sans: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background: radial-gradient(900px 350px at 12% -5%, rgba(59,130,246,.10), transparent 60%),
              radial-gradient(900px 350px at 88% -10%, rgba(22,163,74,.10), transparent 60%),
              var(--bg);
  color:var(--text);
  font-family:var(--sans);
}
.app{max-width:460px;margin:0 auto;padding:18px 16px 28px}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:6px 4px 14px}
.title{font-size:28px;letter-spacing:-.02em;margin:0}
.icon-btn{
  border:0;background:rgba(255,255,255,.65);
  backdrop-filter:saturate(120%) blur(10px);
  -webkit-backdrop-filter:saturate(120%) blur(10px);
  box-shadow: 0 10px 20px rgba(2,6,23,.06);
  width:42px;height:42px;border-radius:999px;
  display:grid;place-items:center;cursor:pointer;color:var(--text);
}
.icon-btn:active{transform:translateY(1px)}
.icon-btn.close{width:40px;height:40px;background:rgba(15,23,42,.04);box-shadow:none}
.dot{width:5px;height:5px;border-radius:50%;background:rgba(15,23,42,.55);display:block;margin:2px 0}
.icon-btn .dot:nth-child(2){opacity:.35}
.icon-btn .dot:nth-child(3){opacity:.22}
.card{
  background:var(--card);
  border:1px solid rgba(15,23,42,.06);
  border-radius:var(--radius);
  box-shadow: var(--shadow);
}
.total-card{padding:16px 16px 14px;position:relative;overflow:hidden}
.total-card::before{
  content:"";position:absolute;inset:-40px -120px auto auto;
  width:240px;height:240px;background: radial-gradient(circle at 30% 30%, rgba(59,130,246,.25), transparent 60%);
  transform:rotate(16deg);pointer-events:none;
}
.kicker{font-size:13px;color:var(--muted);margin-bottom:8px}
.total-amount{font-size:34px;font-weight:740;letter-spacing:-.03em}
.divider{height:1px;background:var(--line);margin:14px 0 10px}
.subnote{font-size:12px;color:var(--muted);display:flex;align-items:center;justify-content:space-between;gap:12px}
.rate-pill{
  border:1px solid rgba(15,23,42,.10);
  background:rgba(15,23,42,.03);
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  color:rgba(15,23,42,.72);
  cursor:pointer;
  user-select:none;
}
.rate-pill:active{transform:translateY(1px)}
.section-head{
  margin-top:18px;
  display:flex;align-items:center;justify-content:space-between;
  gap:12px;padding:4px 2px 10px;
}
.section-title{display:flex;align-items:center;gap:6px}
.section-title h2{margin:0;font-size:22px;letter-spacing:-.02em}
.chev{
  border:0;background:transparent;color:rgba(15,23,42,.55);
  cursor:pointer;padding:8px 6px;border-radius:10px;
}
.chev:active{background:rgba(15,23,42,.04)}
.add-btn{
  border:0;width:44px;height:44px;border-radius:999px;
  background: rgba(22,163,74,.10);
  color: var(--accent);
  cursor:pointer;display:grid;place-items:center;
}
.add-btn:active{transform:translateY(1px)}
.list{display:flex;flex-direction:column;gap:10px}
.item{padding:14px 14px 12px;cursor:pointer;transition:transform .08s ease}
.item:active{transform:translateY(1px)}
.item-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
.amount{font-size:24px;font-weight:760;letter-spacing:-.02em}
.curr{
  font-size:12px;
  font-weight:800;
  opacity:.65;
  margin-left:6px;
  vertical-align:middle;
}
.meta{
  margin-top:4px;
  display:flex;align-items:center;gap:10px;
  color:var(--muted);font-size:13px;
}
.name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
.tail{font-family:var(--mono);font-size:12px;opacity:.9}
.until{margin-left:auto;font-size:12px;opacity:.9}
.footer{margin-top:16px;text-align:center;color:rgba(15,23,42,.45);font-size:12px}
/* Modal */
.modal-backdrop{
  position:fixed;inset:0;
  background: rgba(2,6,23,.45);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  z-index:50;
}
.modal{
  position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
  width:min(460px, calc(100% - 24px));
  background:var(--card);
  border:1px solid rgba(15,23,42,.08);
  border-radius:26px;
  box-shadow: 0 20px 60px rgba(2,6,23,.22);
  z-index:60;
  padding:14px 14px 16px;
}
.modal-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:4px 2px 10px}
.modal-kicker{font-size:12px;color:var(--muted)}
.modal-title{font-size:18px;font-weight:760;letter-spacing:-.02em;margin-top:2px}
.form{display:flex;flex-direction:column;gap:10px;padding:0 2px}
label{display:flex;flex-direction:column;gap:6px}
label span{font-size:12px;color:var(--muted)}
input, select{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(15,23,42,.12);
  outline:none;
  font-size:15px;
  background:rgba(15,23,42,.02);
}
select{appearance:none}
input:focus, select:focus{border-color:rgba(59,130,246,.55); box-shadow:0 0 0 4px rgba(59,130,246,.12)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:360px){.grid2{grid-template-columns:1fr}}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
@media (max-width:560px){.grid3{grid-template-columns:1fr}}
.actions{margin-top:6px;display:flex;gap:10px;justify-content:space-between}
button.primary{
  flex:1;border:0;padding:12px 14px;border-radius:14px;
  background: rgba(59,130,246,.95);
  color:white;font-size:15px;font-weight:700;cursor:pointer;
}
button.primary:active{transform:translateY(1px)}
button.ghost{
  border:1px solid rgba(239,68,68,.35);
  background: rgba(239,68,68,.08);
  color: var(--danger);
  padding:12px 14px;border-radius:14px;cursor:pointer;font-weight:700;
}
/* Toast */
.toast{
  position:fixed;left:50%;top:14px;transform:translateX(-50%);
  background: rgba(15,23,42,.92);
  color: white;
  padding:10px 12px;
  border-radius:999px;
  font-size:13px;
  box-shadow: 0 14px 40px rgba(2,6,23,.25);
  z-index:80;
}
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <h1 class="title">Накопления</h1>
      <button class="icon-btn" id="btnReset" aria-label="Сброс" title="Сброс к данным по умолчанию">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </button>
    </header>
    <section class="card total-card" aria-label="Всего средств">
      <div class="kicker">Всего средств</div>
      <div class="total-amount" id="totalAmount">—</div>
      <div class="divider"></div>
      <div class="subnote">
        <span>Сумма по всем вкладам и счетам</span>
        <span class="rate-pill" id="btnRate" title="Нажмите, чтобы изменить курс">$→₪ <span id="rateText">—</span></span>
      </div>
    </section>
    <section class="section-head">
      <div class="section-title">
        <h2>Вклады и счета</h2>
        <button class="chev" id="btnSort" title="Сортировка" aria-label="Сортировка">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <button class="add-btn" id="btnAdd" aria-label="Добавить" title="Добавить">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
          <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round"/>
        </svg>
      </button>
    </section>
    <main class="list" id="accountsList" aria-label="Список вкладов и счетов"></main>
    <footer class="footer">
      <span id="storageHint">—</span>
    </footer>
  </div>
  <div class="modal-backdrop" id="modalBackdrop" hidden></div>
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" hidden>
    <div class="modal-head">
      <div>
        <div class="modal-kicker" id="modalKicker">Добавить</div>
        <div class="modal-title" id="modalTitle">Вклад / счёт</div>
      </div>
      <button class="icon-btn close" id="btnClose" aria-label="Закрыть">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
          <path d="M6 6l12 12M18 6L6 18" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <form class="form" id="accountForm">
      <input type="hidden" id="fieldId" />
      <label>
        <span>Название</span>
        <input id="fieldName" required placeholder="Напр. paybox" maxlength="60" />
      </label>
      <div class="grid2">
        <label>
          <span>Сумма</span>
          <input id="fieldAmount" required inputmode="decimal" placeholder="0" />
        </label>
        <label>
          <span>Валюта</span>
          <select id="fieldCurrency">
            <option value="ILS">₪ ILS</option>
            <option value="USD">$ USD</option>
            <option value="EUR">€ EUR</option>
            <option value="GBP">£ GBP</option>
          </select>
        </label>
      </div>
      <div class="grid2">
        <label>
          <span>Хвост</span>
          <input id="fieldTail" placeholder="6365" maxlength="16" />
        </label>
        <label>
          <span>Дата/пометка</span>
          <input id="fieldUntil" placeholder="18/10/26" maxlength="30" />
        </label>
      </div>
      <div class="actions">
        <button type="button" class="ghost" id="btnDelete" hidden>Удалить</button>
        <button type="submit" class="primary" id="btnSave">Сохранить</button>
      </div>
    </form>
  </div>
  <div class="modal-backdrop" id="settingsBackdrop" hidden></div>
  <div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" hidden>
    <div class="modal-head">
      <div>
        <div class="modal-kicker">Настройки</div>
        <div class="modal-title" id="settingsTitle">Курс и синхронизация</div>
      </div>
      <button class="icon-btn close" id="btnSettingsClose" aria-label="Закрыть">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
          <path d="M6 6l12 12M18 6L6 18" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <form class="form" id="settingsForm">
      <div class="grid3">
        <label>
          <span>Курс USD→ILS (₪ за $1)</span>
          <input id="fieldRateUsd" required inputmode="decimal" placeholder="3,70" />
        </label>
        <label>
          <span>Курс EUR→ILS (₪ за €1)</span>
          <input id="fieldRateEur" required inputmode="decimal" placeholder="4,00" />
        </label>
        <label>
          <span>Курс GBP→ILS (₪ за £1)</span>
          <input id="fieldRateGbp" required inputmode="decimal" placeholder="4,60" />
        </label>
      </div>
      <div class="grid2">
        <label>
          <span>Общий ключ (для всех устройств)</span>
          <input id="fieldSyncKey" placeholder="Напр. markoson-savings" maxlength="60" />
        </label>
        <label>
          <span>Режим</span>
          <select id="fieldSyncMode">
            <option value="cloud">Cloud (Firebase)</option>
            <option value="local">Только localStorage</option>
          </select>
        </label>
      </div>
      <div class="actions">
        <button type="button" class="ghost" id="btnSettingsClear">Сбросить ключ</button>
        <button type="submit" class="primary">Сохранить</button>
      </div>
      <div style="padding:0 2px;color:rgba(15,23,42,.55);font-size:12px;line-height:1.35;margin-top:2px">
        Чтобы работало «на всех компьютерах», нужен бесплатный backend. В этом файле включена поддержка Firebase Realtime Database.
        Откройте код и вставьте свои <span style="font-family:var(--mono)">firebaseConfig</span> (ниже в &lt;script&gt;). Без этого останется localStorage.
      </div>
    </form>
  </div>
  <div class="toast" id="toast" hidden></div>
  <!-- Firebase (optional). Works only after you paste your firebaseConfig in the script. -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // ====== STORAGE / SYNC SETTINGS ======
  const APP_KEY = "savings_full_working_v2";
  const SETTINGS_KEY = APP_KEY + "_settings";
  // 1) Paste your Firebase config here (Project settings → Web app)
  // If left empty -> cloud sync is disabled, app falls back to localStorage.
  const firebaseConfig = {
    apiKey: "",
    authDomain: "",
    databaseURL: "",
    projectId: "",
    appId: "",
  };
  // ====== DEFAULT DATA ======
  const defaults = [
    { id: cryptoRandomId(), name: "Менора (накопительный)", amount: 41160, currency: "ILS", tail: "6365", until: "" },
    { id: cryptoRandomId(), name: "menora keren ishtalmut", amount: 35998, currency: "ILS", tail: "5098", until: "28\9\28" },
    { id: cryptoRandomId(), name: "Interaktive портфель ($)", amount: 11000, currency: "USD", tail: "3571", until: "" },
    { id: cryptoRandomId(), name: "открытый счет в Discount", amount: 20350, currency: "ILS", tail: "", until: "" },
    { id: cryptoRandomId(), name: "закрытый счет Discount", amount: 253000, currency: "ILS", tail: "", until: "19/03/26" },
    { id: cryptoRandomId(), name: "наличные дома (kaplan)", amount: 3000, currency: "ILS", tail: "", until: "" },
    { id: cryptoRandomId(), name: "мой старый кошелек", amount: 930, currency: "ILS", tail: "", until: "" },
    { id: cryptoRandomId(), name: "paybox", amount: 5808, currency: "ILS", tail: "", until: "" },
    { id: cryptoRandomId(), name: "bit", amount: 1915, currency: "ILS", tail: "", until: "" },
    { id: cryptoRandomId(), name: "master(euro)", amount: 322, currency: "EUR", tail: "", until: "" },
    { id: cryptoRandomId(), name: "master(pounds)", amount: 150, currency: "GBP", tail: "", until: "" },
  ];
  const defaultSettings = {
    usdIls: 3.70,
    eurIls: 4.00,
    gbpIls: 4.60,
    syncMode: "cloud", // cloud | local
    syncKey: "",
  };
  let settings = loadSettings();
  let accounts = loadLocalAccounts(); // will be replaced by cloud if enabled
  let sortMode = "manual"; // manual | amount_desc | amount_asc | name_asc
  const $ = (id) => document.getElementById(id);
  // ====== HELPERS ======
  function cryptoRandomId(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }
  function fmtMoney(n){
    if (!isFinite(n)) return "—";
    const fixed = (Math.round(n * 100) / 100).toFixed(2);
    const parts = fixed.split(".");
    const i = parts[0];
    const d = parts[1];
    const withSpaces = i.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    return `${withSpaces},${d}`;
  }
  function fmtAmountWithCurrency(amount, currency){
    const base = fmtMoney(amount);
    if (currency === "USD") return `${base}<span class="curr">$</span>`;
    if (currency === "EUR") return `${base}<span class="curr">€</span>`;
    if (currency === "GBP") return `${base}<span class="curr">£</span>`;
    return `${base}`;
  }
  function parseMoney(s){
    const clean = String(s ?? "").replace(/\s/g,"").replace(/,/g,".").replace(/[^\d.]/g,"");
    const n = Number(clean);
    return isFinite(n) ? n : NaN;
  }
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function toast(msg){
    const t=$("toast");
    t.textContent=msg;
    t.hidden=false;
    clearTimeout(toast._t);
    toast._t=setTimeout(()=>t.hidden=true, 2000);
  }
  function normalizeAccount(x){
    const name = String(x.name || "Счёт");
    // Auto-detect currency for old records that had "($)" in the name
    const detected = /€|\(euro\)/i.test(name) ? "EUR"
      : /£|\(pound\)|\(pounds\)/i.test(name) ? "GBP"
      : /\$|\(\$\)/.test(name) ? "USD"
      : "ILS";
    const currency = (x.currency === "USD" || x.currency === "EUR" || x.currency === "GBP" || x.currency === "ILS") ? x.currency : detected;
    return {
      id: String(x.id || cryptoRandomId()),
      name,
      amount: Number(x.amount) || 0,
      currency,
      tail: String(x.tail ?? ""),
      until: String(x.until ?? ""),
    };
  }
  function loadSettings(){
    try{
      const raw = localStorage.getItem(SETTINGS_KEY);
      if(!raw) return {...defaultSettings};
      const x = JSON.parse(raw);
      return {
        usdIls: Number(x.usdIls) || defaultSettings.usdIls,
        eurIls: Number(x.eurIls) || defaultSettings.eurIls,
        gbpIls: Number(x.gbpIls) || defaultSettings.gbpIls,
        syncMode: (x.syncMode === "local" || x.syncMode === "cloud") ? x.syncMode : defaultSettings.syncMode,
        syncKey: String(x.syncKey ?? ""),
      };
    }catch{
      return {...defaultSettings};
    }
  }
  function saveSettings(){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  }
  function loadLocalAccounts(){
    try{
      const raw = localStorage.getItem(APP_KEY);
      if (!raw) return defaults.map(normalizeAccount);
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return defaults.map(normalizeAccount);
      return arr.map(normalizeAccount);
    }catch{
      return defaults.map(normalizeAccount);
    }
  }
  function saveLocalAccounts(){
    localStorage.setItem(APP_KEY, JSON.stringify(accounts));
  }
  function isFirebaseConfigured(){
    return !!(firebaseConfig && firebaseConfig.apiKey && firebaseConfig.databaseURL && firebaseConfig.projectId);
  }
  // ====== CLOUD SYNC (Firebase Realtime Database) ======
  let db = null;
  let cloudUnsub = null;
  let cloudReady = false;
  function cloudPath(){
    // simple shared path by syncKey
    const key = (settings.syncKey || "").trim();
    if(!key) return null;
    return "savings_app/" + key;
  }
  function startCloud(){
    if(settings.syncMode !== "cloud") return false;
    if(!isFirebaseConfigured()) return false;
    const p = cloudPath();
    if(!p) return false;
    try{
      const app = firebase.apps && firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
      db = firebase.database(app);
      const ref = db.ref(p);
      // Listen remote
      ref.on("value", (snap)=>{
        const val = snap.val();
        if(val && Array.isArray(val.accounts)){
          accounts = val.accounts.map(normalizeAccount);
        }
        if(val && val.settings){
          const s = val.settings;
          const nextUsd = Number(s.usdIls);
          const nextEur = Number(s.eurIls);
          const nextGbp = Number(s.gbpIls);
          if(isFinite(nextUsd) && nextUsd>0) settings.usdIls = nextUsd;
          if(isFinite(nextEur) && nextEur>0) settings.eurIls = nextEur;
          if(isFinite(nextGbp) && nextGbp>0) settings.gbpIls = nextGbp;
        }
        cloudReady = true;
        updateStorageHint();
        render();
      });
      cloudUnsub = () => ref.off();
      // If no data exists, seed it once
      ref.get().then((snap)=>{
        if(!snap.exists()){
          ref.set({ accounts: accounts, settings: { usdIls: settings.usdIls, eurIls: settings.eurIls, gbpIls: settings.gbpIls } });
        }
      }).catch(()=>{});
      updateStorageHint();
      return true;
    }catch(e){
      console.warn(e);
      return false;
    }
  }
  function stopCloud(){
    if(cloudUnsub){ try{ cloudUnsub(); }catch{} }
    cloudUnsub = null;
    db = null;
    cloudReady = false;
    updateStorageHint();
  }
  function saveCloud(){
    if(!db) return false;
    const p = cloudPath();
    if(!p) return false;
    db.ref(p).update({ accounts: accounts, settings: { usdIls: settings.usdIls, eurIls: settings.eurIls, gbpIls: settings.gbpIls } });
    return true;
  }
  function persist(){
    // Save both: local as cache + cloud if enabled
    saveLocalAccounts();
    saveSettings();
    if(settings.syncMode === "cloud" && isFirebaseConfigured() && cloudPath()){
      saveCloud();
    }
  }
  function updateStorageHint(){
    const el = $("storageHint");
    if(settings.syncMode === "cloud" && isFirebaseConfigured() && cloudPath()){
      el.textContent = cloudReady
        ? "Данные синхронизируются между устройствами (Cloud)."
        : "Cloud включен: ожидание синхронизации…";
    }else{
      el.textContent = "Данные сохраняются только на этом устройстве (localStorage).";
    }
    $("rateText").textContent = `${String(settings.usdIls).replace(".", ",")} · €→₪ ${String(settings.eurIls).replace(".", ",")} · £→₪ ${String(settings.gbpIls).replace(".", ",")}`;
  }
  // ====== TOTALS (ILS) ======
  function totalIls(){
    const usd = Number(settings.usdIls) || 0;
    const eur = Number(settings.eurIls) || 0;
    const gbp = Number(settings.gbpIls) || 0;
    return accounts.reduce((sum,a)=>{
      const amt = Number(a.amount)||0;
      if(a.currency === "USD") return sum + (amt * usd);
      if(a.currency === "EUR") return sum + (amt * eur);
      if(a.currency === "GBP") return sum + (amt * gbp);
      return sum + amt;
    }, 0);
  }
  function sortAccounts(list){
    const arr=[...list];
    if (sortMode==="amount_desc") arr.sort((a,b)=> (b.amount||0) - (a.amount||0));
    if (sortMode==="amount_asc") arr.sort((a,b)=> (a.amount||0) - (b.amount||0));
    if (sortMode==="name_asc") arr.sort((a,b)=> (a.name||"").localeCompare(b.name||"","ru"));
    return arr;
  }
  // ====== UI RENDER ======
  function render(){
    $("totalAmount").textContent = fmtMoney(totalIls());
    $("rateText").textContent = `${String(settings.usdIls).replace(".", ",")} · €→₪ ${String(settings.eurIls).replace(".", ",")} · £→₪ ${String(settings.gbpIls).replace(".", ",")}`;
    const list=$("accountsList");
    list.innerHTML="";
    const sorted = sortAccounts(accounts);
    sorted.forEach(a=>{
      const el=document.createElement("section");
      el.className="card item";
      el.tabIndex=0;
      el.innerHTML = `
        <div class="item-top">
          <div class="amount">${fmtAmountWithCurrency(a.amount, a.currency)}</div>
        </div>
        <div class="meta">
          <div class="name" title="${escapeHtml(a.name)}">${escapeHtml(a.name)}</div>
          <div class="tail">${a.tail ? "•• " + escapeHtml(a.tail) : ""}</div>
          <div class="until">${a.until ? escapeHtml(a.until) : ""}</div>
        </div>
      `;
      el.addEventListener("click", ()=>openModal(a.id));
      el.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" ") openModal(a.id); });
      list.appendChild(el);
    });
  }
  // ====== MODALS ======
  function openModal(id=null){
    const editing = !!id;
    const acc = editing ? accounts.find(a=>a.id===id) : null;
    $("modalKicker").textContent = editing ? "Редактировать" : "Добавить";
    $("fieldId").value = editing ? acc.id : "";
    $("fieldName").value = editing ? acc.name : "";
    $("fieldAmount").value = editing ? String(acc.amount).replace(".", ",") : "";
    $("fieldCurrency").value = editing ? (acc.currency || "ILS") : "ILS";
    $("fieldTail").value = editing ? acc.tail : "";
    $("fieldUntil").value = editing ? acc.until : "";
    $("btnDelete").hidden = !editing;
    $("modalBackdrop").hidden=false;
    $("modal").hidden=false;
    setTimeout(()=>$("fieldName").focus(), 0);
  }
  function closeModal(){
    $("modalBackdrop").hidden=true;
    $("modal").hidden=true;
  }
  function openSettings(){
    $("fieldRateUsd").value = String(settings.usdIls).replace(".", ",");
    $("fieldRateEur").value = String(settings.eurIls).replace(".", ",");
    $("fieldRateGbp").value = String(settings.gbpIls).replace(".", ",");
    $("fieldSyncKey").value = settings.syncKey || "";
$("fieldSyncMode").value = settings.syncMode || "cloud";
    $("settingsBackdrop").hidden=false;
    $("settingsModal").hidden=false;
    setTimeout(()=>$("fieldRateUsd").focus(), 0);
  }
  function closeSettings(){
    $("settingsBackdrop").hidden=true;
    $("settingsModal").hidden=true;
  }
  function cycleSort(){
    const order=["manual","amount_desc","amount_asc","name_asc"];
    const idx=order.indexOf(sortMode);
    sortMode = order[(idx+1)%order.length];
    const map={
      manual:"Сортировка: как добавлено",
      amount_desc:"Сортировка: сумма ↓",
      amount_asc:"Сортировка: сумма ↑",
      name_asc:"Сортировка: по названию",
    };
    toast(map[sortMode] || "Сортировка");
    render();
  }
  // ====== WIRES ======
  $("btnAdd").addEventListener("click", ()=>openModal(null));
  $("btnClose").addEventListener("click", closeModal);
  $("modalBackdrop").addEventListener("click", closeModal);
  $("btnSort").addEventListener("click", cycleSort);
  $("btnRate").addEventListener("click", openSettings);
  $("btnSettingsClose").addEventListener("click", closeSettings);
  $("settingsBackdrop").addEventListener("click", closeSettings);
  $("btnReset").addEventListener("click", ()=>{
    const ok = confirm("Сбросить данные к исходным?");
    if(!ok) return;
    accounts = defaults.map(x=>({ ...normalizeAccount(x), id: cryptoRandomId() }));
    sortMode="manual";
    persist();
    render();
    toast("Сброшено");
  });
  $("btnDelete").addEventListener("click", ()=>{
    const id=$("fieldId").value;
    const acc=accounts.find(a=>a.id===id);
    if(!acc) return;
    const ok=confirm(`Удалить “${acc.name}”?`);
    if(!ok) return;
    accounts = accounts.filter(a=>a.id!==id);
    persist();
    closeModal();
    render();
    toast("Удалено");
  });
  $("accountForm").addEventListener("submit", (e)=>{
    e.preventDefault();
    const id = $("fieldId").value || cryptoRandomId();
    const name = $("fieldName").value.trim() || "Счёт";
    const amount = parseMoney($("fieldAmount").value);
    if(!isFinite(amount)){
      toast("Введите сумму");
      $("fieldAmount").focus();
      return;
    }
    const currency = $("fieldCurrency").value === "USD" ? "USD" : "ILS";
    const tail = $("fieldTail").value.trim();
    const until = $("fieldUntil").value.trim();
    const obj = normalizeAccount({ id, name, amount, currency, tail, until });
    const idx = accounts.findIndex(a=>a.id===id);
    if(idx>=0) accounts[idx]=obj;
    else accounts.push(obj);
    persist();
    closeModal();
    render();
    toast("Сохранено");
  });
  $("settingsForm").addEventListener("submit", (e)=>{
    e.preventDefault();
    const usd = parseMoney($("fieldRateUsd").value);
    const eur = parseMoney($("fieldRateEur").value);
    const gbp = parseMoney($("fieldRateGbp").value);
    if(!isFinite(usd) || usd<=0){ toast("Введите курс USD→ILS"); $("fieldRateUsd").focus(); return; }
    if(!isFinite(eur) || eur<=0){ toast("Введите курс EUR→ILS"); $("fieldRateEur").focus(); return; }
    if(!isFinite(gbp) || gbp<=0){ toast("Введите курс GBP→ILS"); $("fieldRateGbp").focus(); return; }
    const nextMode = $("fieldSyncMode").value === "local" ? "local" : "cloud";
    const nextKey = $("fieldSyncKey").value.trim();
    const modeChanged = nextMode !== settings.syncMode;
    const keyChanged = nextKey !== (settings.syncKey || "");
    settings.usdIls = usd;
    settings.eurIls = eur;
    settings.gbpIls = gbp;
    settings.syncMode = nextMode;
    settings.syncKey = nextKey;
    saveSettings();
    updateStorageHint();
    // restart cloud if needed
    if(modeChanged || keyChanged){
      stopCloud();
      // Always keep local cache
      saveLocalAccounts();
      if(settings.syncMode === "cloud"){
        const started = startCloud();
        if(!started) toast("Cloud не активен (нет firebaseConfig или ключа)");
      }
    }
    persist();
    render();
    closeSettings();
    toast("Настройки сохранены");
  });
  $("btnSettingsClear").addEventListener("click", ()=>{
    settings.syncKey = "";
    settings.syncMode = "local";
    saveSettings();
    stopCloud();
    updateStorageHint();
    toast("Ключ сброшен");
    openSettings(); // refresh fields
  });
  window.addEventListener("keydown", (e)=>{
    if(e.key==="Escape"){
      if(!$("modal").hidden) closeModal();
      if(!$("settingsModal").hidden) closeSettings();
    }
  });
  // ====== INIT ======
  updateStorageHint();
  // try cloud
  const started = startCloud();
  if(!started){
    // local only
    render();
  }else{
    // render will be called when cloud data arrives; still show local immediately
    render();
  }
});
</script>
</body>
</html>
